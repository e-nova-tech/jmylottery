!function(a){"use strict";var b=a.cofda||{},c={donut:{width:80,height:80,text_y:".35em",duration:500,transition:200,thickness:15},feedbacks:{50:"Low score, please try again.",80:"Not perfect, but good.",100:"Bravo ! You nailed it."}};b.donut_chart=function(b,d,e){var f=(a(b),a.extend(!0,c.donut,e)),g=function(){var a=f.width,c=f.height,e=f.text_y,g={lower:h(0),upper:h(d)},i=Math.min(a,c)/2,j=d3.layout.pie().sort(null),k=d3.format(".0%"),l=d3.svg.arc().innerRadius(i-f.thickness).outerRadius(i),m=d3.select(b).append("svg").attr("width",a).attr("height",c).append("g").attr("transform","translate("+a/2+","+c/2+")"),n=m.selectAll("path").data(j(g.lower)).enter().append("path").attr("class",function(a,b){return"color"+b}).attr("d",l).each(function(a){this._current=a}),o=m.append("text").attr("text-anchor","middle").attr("dy",e);if("string"==typeof d)o.text(d);else var p=0,q=setTimeout(function(){clearTimeout(q),n=n.data(j(g.upper)),n.transition().duration(f.duration).attrTween("d",function(a){var b=d3.interpolate(this._current,a),c=d3.interpolate(p,d);return this._current=b(0),function(a){return o.text(k(c(a)/100)),l(b(a))}})},200)},h=function(a){return[a,100-a]};g()},b.showScore=function(d,e,f){var g=a(d),h=a.extend(!0,c,f),i=function(){var a='<div class="feedback clearfix" style="display: none;"><p></p><div class="score"><div id="donut" class="donut"></div></div></div>';return a},j=function(){var c=i(),d=a(c);g.prepend(d),d.show();var f=null;for(var j in h.feedbacks)if(j>=e){f=h.feedbacks[j];break}b.donut_chart("#donut",e,h.donut),a(".feedback p",g).text(f)};j()},a.cofda=b}(jQuery,this,document),$.cofPlayer={totalMedias:0,loadedMedias:0,currentKey:1},jQuery.fn.cofPlayer=function(a){function b(){g=$(e.mediaSelector).length,$(e.loader.container).hasClass("has-jmyloader")||$(e.loader.container).jMyLoader(e.loader),$(e.loader.container).jMyLoader("add-items",g),$(e.mediaSelector).each(function(){var a=$.cofPlayer.currentKey,b=$(this).is("a")?!1:!0,d=null;b?(d=$(this),d.prepend('<div id="'+e.keyPrefix+a+'" class="jplayer"></div>'),d.attr("rel",e.keyPrefix+a),d.hover(function(){$(this).addClass("hover")}).mouseleave(function(){$(this).removeClass("hover")})):$("body").prepend('<div id="jPlayer-'+a+'" class="jplayer"></div>');var g=null;g=b?$('[href$="mp3"]',$(this)):$(this);var h=g.attr("href"),i=h,j=i.replace(/mp3/g,"ogg"),k=$("#jPlayer-"+a);f[a]=k.jPlayer({supplied:"mp3, oga",swfPath:"/cakephp/js/lib/jQuery.jPlayer.2.5.0",solution:"html,flash",preload:"auto",ready:function(f){1==f.jPlayer.html.used&&(e.fullHtml5=!0),$(this).jPlayer("setMedia",{mp3:i,oga:j}),b&&d.addClass("loading"),1==f.jPlayer.html.used?k.bind($.jPlayer.event.loadeddata,function(b){c(a,b.jPlayer.status.duration)}):k.bind($.jPlayer.event.progress,function(b){100===b.jPlayer.status.seekPercent&&c(a,b.jPlayer.status.duration)})}}),f[a].bind($.jPlayer.event.play,function(a,c){var f=$(a.currentTarget).attr("id");c=$(e.mediaSelector+"[rel="+f+"]"),e.beforePlay&&jQuery.isFunction(e.beforePlay)&&e.beforePlay(c),b&&d.addClass("playing")}),k.bind($.jPlayer.event.ended,function(a,c){var f=$(a.currentTarget).attr("id");c=$(e.mediaSelector+"[rel="+f+"]"),e.afterPlay&&jQuery.isFunction(e.afterPlay)&&e.afterPlay(c),b&&d.removeClass("playing")}),g.click(function(){return k.jPlayer("play"),!1}),$.cofPlayer.currentKey++})}function c(a,b){var c=this;h++,$(e.loader.container).jMyLoader("increment-loaded-item");var d=$(e.mediaSelector+"[rel="+e.keyPrefix+a+"]");d.removeClass("loading"),c.totalDuration+=b}var d={mediaSelector:"div.sound",fullHtml5:!1,playRate:1,beforePlay:null,afterPlay:null,keyPrefix:"jPlayer-",loader:{container:"body",size:300,onLoaded:null}},e=$.extend({},d,a),f=Array(),g=0,h=0;return $.fn.cofPlay=function(){this.each(function(){return $(this).find(".jplayer").length?($(".jplayer",$(this)).jPlayer("play"),$(this)):!1})},this.each(function(){var a=$(this);b(a)})};var jHearNClick=function(a,b){this.defaults={mediaSelector:"div.sound",matchSelector:"div.match",helpSelector:".help",showActiveSoundOnly:!0,answers:null,onBeforeInit:null,onAfterInit:null,onAfterClickMatchCorrect:null,onAfterClickMatchIncorrect:null,onErrorBehavior:"tryagain",onNextSound:null,onLoaded:null,onFinish:null,successClass:"success",errorClass:"error",activeClass:"active",soundsPath:"sounds/",donut:{width:80,height:80,text_y:".30em",duration:500,transition:200,thickness:10},feedbacks:{50:"Low score, please try again.",80:"Good, but not perfect.",100:"You nailed it. Bravo !"},contextualHelp:{afterInit:"Click on the blue element to hear a number, then select the corresponding digit in the options below.",onMatchCorrect:"Bravo ! It's correct.<br/>Continue and play next item.",onMatchIncorrect:"Wrong choice. Please try again.",onAfterPlay:"Select corresponding option in blue"}},this.settings=$.extend({},this.defaults,b),this.lastEltPlayed=null,this.nbErrors=0,this.progress=0,this.app=$(a),this.totalSounds=0,this.roundPoint=0,this.totalScore=0,this.init()};jHearNClick.prototype.init=function(){var a=this;this.settings.onBeforeInit&&jQuery.isFunction(this.settings.onBeforeInit)&&this.settings.onBeforeInit(),this.app.hasClass("has-jmyloader")||($(this.app).cofPlayer({mediaSelector:this.settings.mediaSelector,loader:{size:200,container:this.app,onLoaded:this.settings.onLoaded},afterPlay:function(b){a.onAfterPlay(b)}}),this.app.append('<div class="appsound success" id="123-456-789"><a href="'+this.settings.soundsPath+'mp3/success.mp3"></a></div>'),this.app.append('<div class="appsound error" id="123-456-789"><a href="'+this.settings.soundsPath+'mp3/error.mp3"></a></div>'),$(this.app).cofPlayer({mediaSelector:"div.appsound",loader:{size:200,container:this.app,onLoaded:this.settings.onLoaded}}),$(".match a").click(function(){return a.onClickMatch($(this)),!1}),$(".actions .reset",this.app).click(function(){return"disabled"==$(this).attr("disabled")?!1:void a.onReset()})),this.settings.showActiveSoundOnly&&($(this.settings.mediaSelector).hide(),$(this.settings.mediaSelector+":first").show(),$(this.settings.mediaSelector+":first").addClass(this.settings.activeClass)),this.progress=1,this.totalSounds=$(this.settings.mediaSelector,this.app).length,$(".progress .current",this.app).text(this.progress),$(".progress .total",this.app).text(this.totalSounds),$(".actions .reset").attr("disabled","disabled"),this.contextualHelp(this.settings.contextualHelp.afterInit,null),this.settings.onAfterInit&&jQuery.isFunction(this.settings.onAfterInit)&&this.settings.onAfterInit()},jHearNClick.prototype.onAfterPlay=function(a){this.lastEltPlayed=a,$(a).removeClass(this.settings.activeClass),$(this.settings.matchSelector).addClass(this.settings.activeClass),this.contextualHelp(this.settings.contextualHelp.onAfterPlay,null)},jHearNClick.prototype.onClickMatch=function(a){var b=a.closest(this.settings.matchSelector);if(!b.hasClass(this.settings.activeClass))return!1;var c=b.attr("id"),d=this.lastEltPlayed.attr("id");return this.settings.answers[d]==c?this.onClickMatchCorrect(a):this.onClickMatchIncorrect(a),!1},jHearNClick.prototype.onClickMatchCorrect=function(a){this.roundPoint+=1,a.closest(this.settings.matchSelector).addClass(this.settings.successClass),$(this.settings.matchSelector).removeClass(this.settings.errorClass),this.goToNextSound(),this.progress<this.totalSounds?this.contextualHelp(this.settings.contextualHelp.onMatchCorrect,"green"):this.contextualHelp("",null),$(".appsound.success",this.app).cofPlay(),this.settings.onAfterClickMatchCorrect&&jQuery.isFunction(this.settings.onAfterClickMatchCorrect)&&this.settings.onAfterClickMatchCorrect(a)},jHearNClick.prototype.onClickMatchIncorrect=function(a){this.roundPoint-=1,a.closest(this.settings.matchSelector).addClass(this.settings.errorClass),this.nbErrors++,"tryagain"==this.settings.onErrorBehavior&&this.contextualHelp(this.settings.contextualHelp.onMatchIncorrect,"red"),$(".appsound.error",this.app).cofPlay(),this.settings.onAfterClickMatchIncorrect&&jQuery.isFunction(this.settings.onAfterClickMatchIncorrect)&&this.settings.onAfterClickMatchIncorrect(a)},jHearNClick.prototype.onReset=function(){$(this.settings.mediaSelector,this.app).show().removeClass(this.settings.activeClass).css("margin-left",""),$(this.settings.matchSelector,this.app).removeClass(this.settings.successClass).removeClass(this.settings.errorClass).removeClass(this.settings.activeClass),$(".feedback",this.app).remove(),this.contextualHelp(this.settings.contextualHelp.afterInit,null),this.lastEltPlayed=null,this.nbErrors=0,this.progress=0,this.totalSounds=0,this.roundPoint=0,this.totalScore=0,this.init(this.app)},jHearNClick.prototype.goToNextSound=function(){this.roundPoint>0&&(this.totalScore+=1),this.roundPoint=0,$(this.settings.matchSelector).removeClass(this.settings.activeClass),$(this.settings.matchSelector).removeClass(this.settings.errorClass);var a=this.lastEltPlayed.next();this.settings.onNextSound&&jQuery.isFunction(this.settings.onNextSound)&&this.settings.onNextSound(this.lastEltPlayed,a),a.addClass(this.settings.activeClass),this.progress++,this.progress<=this.totalSounds?$(".progress .current",this.app).text(this.progress):this.onFinish()},jHearNClick.prototype.onFinish=function(){this.settings.onFinish&&jQuery.isFunction(this.settings.onFinish)&&this.settings.onFinish(),this.displayScore(),$(".actions .reset").removeAttr("disabled")},jHearNClick.prototype.displayScore=function(){var a=this.totalScore,b=Math.round(a/this.totalSounds*100);b>100&&(b=100),$.cofda.showScore(this.app,b,this.settings)},jHearNClick.prototype.contextualHelp=function(a,b){$(this.settings.helpSelector,this.app).html("<p"+(null!=b?' class="'+b+'"':"")+">"+a+"</p>")},jQuery.fn.jHearNClick=function(a){var b=null;return this.each(function(){var c=$(this),d=new jHearNClick(c,a);return b=d,d}),b},jQuery.fn.jMyLottery=function(a){var b={onNextSound:function(a,b){a.animate({marginLeft:"-=100"},500,function(){$(this).hide()}),b.css("margin-left",d.width()),b.show(),b.animate({marginLeft:"0"},1e3)}},c=$.extend({},b,a),d=null,e=function(a){d=a,$(a).jHearNClick(c)};return this.each(function(){var a=$(this);return e(a),$(this)})};